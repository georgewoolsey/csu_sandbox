# Constrained Area vs. Treated Area

```{r, include=FALSE, warning=F, message=F}
# knit options
knitr::opts_chunk$set(
  echo = TRUE
  , warning = FALSE
  , message = FALSE
  , results='hide'
  , fig.width = 10
  , fig.height = 7
)
# bread-and-butter
library(tidyverse)
library(lubridate)
library(viridis)
library(scales)
library(latex2exp)
# visualization
library(kableExtra)
library(cowplot)
library(RColorBrewer)
library(mapview) #Interactive maps
library(leafpop) #map html popup
# spatial analysis
library(sf)
library(USAboundaries)
library(nhdplusTools) # watershed boundaries
library(googlesheets4) # googlesheets4
# set seed
set.seed(11)
```

```{r, results='hide'}
# turn off the s2 processing 
## https://stackoverflow.com/questions/68478179/how-to-resolve-spherical-geometry-failures-when-joining-spatial-data
sf::sf_use_s2(FALSE)
```

### Read in Constraint and AOI Bounds

This data was created in this [prior section](#wf_read_sw) and this [prior section](#wflndscp).

```{r const-rd_dta, results='hide'}
# constraint by ftr, huc12
constrained_byftr_huc12_wide_sf <- sf::st_read("../data/constrained_byftr_huc12_wide_sf.gpkg")
# set crs
transform_crs <- sf::st_crs(constrained_byftr_huc12_wide_sf)
# constraint by wf landscape
constrained_by_wflndscp_wide_sf <- sf::st_read("../data/constrained_by_wflndscp_wide_sf.gpkg") |> 
  sf::st_transform(transform_crs)
# treatment targets
treatment_targets <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1qVtOIcpJuN-7QOWY_rhnSIUGILvbOXeM_ASXxa6a5q8/edit?usp=sharing") |> 
  dplyr::inner_join(
    constrained_by_wflndscp_wide_sf |> 
      sf::st_drop_geometry() |> 
      dplyr::select(
        state,name,area_name
      )
    , by = dplyr::join_by(state,name)
  )

```


```{r include=FALSE, eval=FALSE}
mapview::mapview(constrained_byftr_huc12_wide_sf, zcol = "cnstrnt_class"
  , col.regions = RColorBrewer::brewer.pal(n=3,name="RdYlBu") |> rev()
  , alpha.regions = 0.6
  , lwd = 0.2
  , label = FALSE
  , legend = FALSE)
```

## Forest Management Activities (FACTS)

The Hazardous Fuel Treatments metadata file is available [here](https://data.fs.usda.gov/geodata/edw/edw_resources/meta/S_USA.Activity_HazFuelTrt_PL.xml) and the Timber Harvests metadata file is available [here](https://data.fs.usda.gov/geodata/edw/edw_resources/meta/S_USA.Activity_TimberHarvest.xml). 

[This appendix](https://www.fs.usda.gov/Internet/FSE_DOCUMENTS/fseprd539041.pdf) includes a listing of all the active and inactive FACTS activity codes, as well as detailed descriptions of some of the codes.

```{r facts-load}
# check for data and download
zip_path <- c(
    "https://data.fs.usda.gov/geodata/edw/edw_resources/fc/S_USA.Activity_HazFuelTrt_PL.gdb.zip"  # haz fuel
    , "https://data.fs.usda.gov/geodata/edw/edw_resources/fc/S_USA.Activity_TimberHarvest.gdb.zip" # timber harv
  )
for (i in 1:length(zip_path)) {
  f_nm <- paste0( "../data/"
    , str_split(zip_path[i], "/", simplify = TRUE)[length(str_split(zip_path[i], "/", simplify = TRUE))]
  )
  fldr <- paste0(gsub(".zip", "", f_nm))
  options(timeout = 60 * 15)
  if(file.exists(fldr) == FALSE){
    # download data
    if(file.exists(f_nm) == FALSE){
      download.file(zip_path[i], destfile = f_nm)
    }else{print("file already exists")}
    # unzip
    unzip(f_nm, overwrite=TRUE, exdir = fldr)
    file.remove(f_nm)
  }else{print("unzip already exists")}
}
# haz_fuel
haz_fuel <- sf::st_read(
    dsn = "../data/S_USA.Activity_HazFuelTrt_PL.gdb/S_USA.Activity_HazFuelTrt_PL.gdb"
    , layer = "Activity_HazFuelTrt_PL"
    # , query = "SELECT * FROM \"Activity_HazFuelTrt_PL\" 
    #             WHERE 
    #               STAGE_VALUE IN ('ACCOMPLISHED')
    #               AND FISCAL_YEAR_COMPLETED = '2023'
    #   "
  ) |>  
  rename_with(~ tolower(
    gsub(" ", "_", 
       str_trim(gsub("\\s+", " ", .x))
    )
  )) |>
  # filter
  dplyr::filter(
    tolower(stage_value) == "accomplished"
    & tolower(cat_nm) %in% c("mechanical", "fire")
    & !stringr::str_detect("pile burn", tolower(treatment_type))
    & fiscal_year_completed >= lubridate::year(Sys.Date())-16
    & fiscal_year_completed <= lubridate::year(Sys.Date())
    # & lubridate::year(date_completed) >= lubridate::year(Sys.Date())-16
    # & lubridate::year(date_completed) <= lubridate::year(Sys.Date())
  )
  #rename sf geom column
  names(haz_fuel)[names(haz_fuel)==tolower(attr(haz_fuel, "sf_column"))] = "geometry"
  sf::st_geometry(haz_fuel) = "geometry"
  # transform
  haz_fuel <- haz_fuel |>  
    sf::st_transform(crs=transform_crs) |>  
    dplyr::filter(sf::st_is_valid(geometry)) |>  
    dplyr::mutate(
      facts_src = "haz_fuel"
      , treatment_type = trimws(treatment_type)
      , treatment_category = tolower(cat_nm)
      # , treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
    ) |> 
    dplyr::select(suid, facts_src, treatment_category, treatment_type, date_completed, fiscal_year_completed)
  gc()
# timber harvest
harvests <- sf::st_read(
    dsn = "../data/S_USA.Activity_TimberHarvest.gdb/S_USA.Activity_TimberHarvest.gdb"
    , layer = "Activity_TimberHarvest"
    # , query = "SELECT * FROM \"Activity_TimberHarvest\"
    #             WHERE
    #               STAGE_DESC IN ('ACCOMPLISHED')
    #               AND FY_COMPLETED = '2023'
    #   "
  ) |> 
  rename_with(~ tolower(
    gsub(" ", "_",
       str_trim(gsub("\\s+", " ", .x))
    )
  )) |>  
  dplyr::mutate(fiscal_year_completed = as.numeric(fy_completed)) |> 
  dplyr::filter(
    tolower(stage_desc) == "accomplished"
    & tolower(treatment_type) != "n/a"
    & fiscal_year_completed >= lubridate::year(Sys.Date())-16
    & fiscal_year_completed <= lubridate::year(Sys.Date())
    # & lubridate::year(date_completed) >= lubridate::year(Sys.Date())-16
    # & lubridate::year(date_completed) <= lubridate::year(Sys.Date())
  )
  #rename sf geom column
  names(harvests)[names(harvests)==tolower(attr(harvests, "sf_column"))] = "geometry"
  sf::st_geometry(harvests) = "geometry"
  # transform
  harvests <- harvests |>  
    sf::st_transform(crs=transform_crs) |>  
    dplyr::filter(sf::st_is_valid(geometry)) |>  
    dplyr::mutate(
      facts_src = "harvests"
      , treatment_category = "mechanical"
      , treatment_type = trimws(treatment_type)
      # , treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
    ) |> 
    dplyr::select(suid, facts_src, treatment_category, treatment_type, date_completed, fiscal_year_completed)
gc()
```

```{r, warning=F, message=F, echo=FALSE, include=FALSE}
remove(list = c("f_nm", "fldr", "zip_path"))
gc()
```

Combine treatment layers with landscape areas

```{r}
# combine with wfp areas
treatment_in_landscapes <- rbind(
  # harvests
    sf::st_intersection(
      harvests
      , constrained_by_wflndscp_wide_sf |> 
        dplyr::select(area_name)
    )
  , # haz fuel
    sf::st_intersection(
      haz_fuel
      , constrained_by_wflndscp_wide_sf |> 
        dplyr::select(area_name)
    )
) 
# aggregate by type, area !!!! because some treatment types might overlap spatially
treatment_by_type_area <- treatment_in_landscapes |> 
  dplyr::group_by(area_name, treatment_category) |> 
  dplyr::summarise(
    geometry = sf::st_union(geometry)
    , n_treatments = dplyr::n_distinct(suid)
    , min_fiscal_year_completed = min(fiscal_year_completed)
    , max_fiscal_year_completed = max(fiscal_year_completed)
  ) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(
    treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
    , pot_min_fiscal_year_completed = lubridate::year(Sys.Date())-16
    , pot_max_fiscal_year_completed = lubridate::year(Sys.Date())
  ) |> 
  sf::st_drop_geometry()
# join with full data
treatment_by_type_area <- dplyr::cross_join(
    # unique trt types
    treatment_in_landscapes |> 
      sf::st_drop_geometry() |> 
      dplyr::count(treatment_category) |> 
      dplyr::select(-c(n))
    # unique areas
    , constrained_by_wflndscp_wide_sf |> 
      sf::st_drop_geometry() |> 
      dplyr::count(area_name) |> 
      dplyr::select(-c(n))
  ) |> 
  dplyr::left_join(
    treatment_by_type_area
    , by = dplyr::join_by(area_name, treatment_category)
  ) |> 
  dplyr::mutate(
    treatment_area_ha = ifelse(is.na(treatment_area_ha), 0, treatment_area_ha)
    , treatment_area_acres = (treatment_area_ha*10000)/4046.85642
  ) |> 
  dplyr::inner_join(constrained_by_wflndscp_wide_sf |> sf::st_drop_geometry(), by = dplyr::join_by(area_name))

# aggregate by year, area !!!! because some treatment types might overlap spatially
treatment_by_area_yr <- treatment_in_landscapes |> 
  dplyr::mutate(treatment_year = lubridate::year(date_completed)) |> 
  dplyr::group_by(
      fiscal_year_completed
      , area_name
  ) |> 
  dplyr::summarise(geometry = sf::st_union(geometry)) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(
    treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
  ) |> 
  sf::st_drop_geometry()


# aggregate by year, trt type, area
treatment_by_type_area_yr <- treatment_in_landscapes |> 
  dplyr::mutate(treatment_year = lubridate::year(date_completed)) |> 
  dplyr::group_by(
      fiscal_year_completed
      , facts_src
      , treatment_category
      , area_name
  ) |> 
  dplyr::summarise(geometry = sf::st_union(geometry)) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(
    treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
  ) |> 
  sf::st_drop_geometry()

# create full set of data with all possible combinations
base_join_temp <- constrained_by_wflndscp_wide_sf |> 
  sf::st_drop_geometry() |> 
  dplyr::count(area_name) |> 
  dplyr::select(-c(n)) |> 
  # cross with treatment types
  dplyr::cross_join(
    treatment_by_type_area_yr |> 
      dplyr::count(facts_src,treatment_category) |> 
      dplyr::select(-c(n))
  ) |> 
  # cross with years
  dplyr::cross_join(data.frame(fiscal_year_completed = unique(treatment_by_type_area_yr$fiscal_year_completed)))
# JOIN WITH aggregated data  
# treatment_by_type_area_yr
  treatment_by_type_area_yr <- base_join_temp |> 
    dplyr::left_join(treatment_by_type_area_yr, by = dplyr::join_by(area_name,fiscal_year_completed,facts_src,treatment_category)) |> 
    dplyr::mutate(
      treatment_area_ha = ifelse(is.na(treatment_area_ha), 0, treatment_area_ha)
      , treatment_label = paste0(facts_src,": ",treatment_category) |> tolower()
      , treatment_area_acres = (treatment_area_ha*10000)/4046.85642
    ) |> 
    dplyr::inner_join(constrained_by_wflndscp_wide_sf |> sf::st_drop_geometry(), by = dplyr::join_by(area_name))

# treatment_by_area_yr
  treatment_by_area_yr <- base_join_temp |> 
    dplyr::count(area_name, fiscal_year_completed) |> 
    dplyr::select(-c(n)) |> 
    dplyr::left_join(treatment_by_area_yr, by = dplyr::join_by(area_name,fiscal_year_completed)) |> 
    dplyr::mutate(
      treatment_area_ha = ifelse(is.na(treatment_area_ha), 0, treatment_area_ha)
      , treatment_area_acres = (treatment_area_ha*10000)/4046.85642
    ) |> 
    dplyr::inner_join(constrained_by_wflndscp_wide_sf |> sf::st_drop_geometry(), by = dplyr::join_by(area_name))

```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

Combine treatment layers with watersheds

```{r}
# combine with wfp areas
treatment_in_watersheds <- rbind(
  # harvests
    sf::st_intersection(
      harvests
      , constrained_byftr_huc12_wide_sf |> 
        dplyr::select(area_name, huc12, cnstrnt_class, rmn_cnstrnt_class)
    )
  , # haz fuel
    sf::st_intersection(
      haz_fuel
      , constrained_byftr_huc12_wide_sf |> 
        dplyr::select(area_name, huc12, cnstrnt_class, rmn_cnstrnt_class)
    )
) 
gc()
# aggregate by year, area !!!! because some treatment types might overlap spatially
treatment_by_cnstrnt_area_yr <- treatment_in_watersheds |> 
  dplyr::mutate(treatment_year = lubridate::year(date_completed)) |> 
  dplyr::group_by(
      fiscal_year_completed
      , area_name
      , cnstrnt_class, rmn_cnstrnt_class
  ) |> 
  dplyr::summarise(geometry = sf::st_union(geometry)) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(
    treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
  ) |> 
  sf::st_drop_geometry()
gc()

# aggregate by year, trt type, area
treatment_by_cnstrnt_type_area_yr <- treatment_in_watersheds |> 
  dplyr::mutate(treatment_year = lubridate::year(date_completed)) |> 
  dplyr::group_by(
      fiscal_year_completed
      , treatment_category
      , area_name
      , cnstrnt_class, rmn_cnstrnt_class
  ) |> 
  dplyr::summarise(geometry = sf::st_union(geometry)) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(
    treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
  ) |> 
  sf::st_drop_geometry()
gc()


# create full set of data with all possible combinations
base_join_temp <- constrained_byftr_huc12_wide_sf |> 
  sf::st_drop_geometry() |> 
  dplyr::count(area_name, cnstrnt_class, rmn_cnstrnt_class) |> 
  dplyr::select(-c(n)) |> 
  # cross with treatment types
  dplyr::cross_join(
    treatment_by_cnstrnt_type_area_yr |> 
      dplyr::count(treatment_category) |> 
      dplyr::select(-c(n))
  ) |> 
  # cross with years
  dplyr::cross_join(data.frame(fiscal_year_completed = unique(treatment_by_cnstrnt_type_area_yr$fiscal_year_completed)))
# JOIN WITH aggregated data  
# treatment_by_type_area_yr
  treatment_by_cnstrnt_type_area_yr <- base_join_temp |> 
    dplyr::left_join(treatment_by_cnstrnt_type_area_yr, by = dplyr::join_by(
      area_name,cnstrnt_class, rmn_cnstrnt_class
      , fiscal_year_completed,treatment_category
    )) |> 
    dplyr::mutate(
      treatment_area_ha = ifelse(is.na(treatment_area_ha), 0, treatment_area_ha)
      , treatment_area_acres = (treatment_area_ha*10000)/4046.85642
    )

# treatment_by_area_yr
  treatment_by_cnstrnt_area_yr <- base_join_temp |> 
    dplyr::count(fiscal_year_completed, area_name, cnstrnt_class, rmn_cnstrnt_class) |> 
    dplyr::select(-c(n)) |> 
    dplyr::left_join(treatment_by_cnstrnt_area_yr
      , by = dplyr::join_by(
        fiscal_year_completed, area_name, cnstrnt_class, rmn_cnstrnt_class
      )
    ) |> 
    dplyr::mutate(
      treatment_area_ha = ifelse(is.na(treatment_area_ha), 0, treatment_area_ha)
      , treatment_area_acres = (treatment_area_ha*10000)/4046.85642
    ) 
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
remove(harvests,haz_fuel)
gc()
```

## Treatment acres by year table

```{r}
treatment_table_temp <- treatment_by_type_area_yr |> 
  dplyr::filter(fiscal_year_completed>=2022) |> 
  dplyr::mutate(nm = paste(facts_src,treatment_category,sep = "_")) |> 
  dplyr::select(area_name,fiscal_year_completed,nm,tidyselect::starts_with("treatment_area")) |> 
  tidyr::pivot_wider(
    names_from = nm
    , values_from = tidyselect::starts_with("treatment_area")
    , names_glue = "{nm}_{.value}"
    , values_fill = 0
  ) |> 
  # join with targets
  dplyr::left_join(
    treatment_targets |> 
      dplyr::select(area_name, tidyselect::starts_with("target_acres_20")) |> 
      tidyr::pivot_longer(
        cols = tidyselect::starts_with("target_acres_20")
        , names_to = "fiscal_year_completed"
        , values_to = "target_area_acres"
        , names_prefix = "target_acres_"
        , values_drop_na = F
      ) |> 
      dplyr::mutate(dplyr::across(
        c(fiscal_year_completed,target_area_acres)
        , ~ as.numeric(.x)
      ))
    , by = dplyr::join_by(area_name,fiscal_year_completed)
  ) |> 
  dplyr::inner_join(
    treatment_by_area_yr |> 
      dplyr::select(area_name, fiscal_year_completed, tidyselect::starts_with("treatment_area")) |> 
      dplyr::rename_with(
        ~ paste0("total_", .x)
        , tidyselect::starts_with("treatment_area")
      )
    , by = dplyr::join_by(area_name, fiscal_year_completed)
  ) |> 
  # mutates
  dplyr::mutate(
    pct_to_target = scales::percent(total_treatment_area_acres/target_area_acres,accuracy=0.1)
    , dplyr::across(tidyselect::contains("_area_"), ~ scales::comma(.x,accuracy = 1))
  )
# make a table
kableExtra::kable(
    treatment_table_temp |> dplyr::select(
      fiscal_year_completed
      , tidyselect::ends_with("treatment_area_acres")
      , target_area_acres
      , pct_to_target
    )
    , caption = "Treatments in 21 Wildfire Crisis Strategy Priority Landscapes<br>*only treatments on National Forest System lands shown"
    , col.names = c(
      " "
      , "Timber Harvest: mechanical"
      , "Hazardous Fuel Treatment: fire"
      , "Hazardous Fuel Treatment: mechanical"
      , "Total Treated*"
      , "Target Treated"
      , "% to Target"
    )
  ) |>  
  kableExtra::add_header_above(c(" " = 1, "Acres"=5," "=1)) |>
  kableExtra::kable_classic(full_width=T) |> 
  kableExtra::pack_rows(index = table(forcats::fct_inorder(treatment_table_temp$area_name))) |>
  kableExtra::kable_styling(font_size = 11,fixed_thead = TRUE) |> 
  kableExtra::footnote(
    general = paste0(
      "treatment by fiscal year completed"
      , " | last updated: "
      , file.info("../data/S_USA.Activity_HazFuelTrt_PL.gdb/")$ctime |> lubridate::as_date()
    )
    , symbol = c("overlapping area counted once")
  )
```

## Treatment acres by type plot

```{r}
treatment_by_type_area_yr |> 
  dplyr::filter(fiscal_year_completed>=2022)
```



```{r}
# "Hazardous Fuel Treatment"

ggplot(
  data = treatment_by_type_area_yr
  , mapping = aes(x = treatment_year, y = treatment_area_ha, color = treatment_label)
) +
  geom_line() + 
  facet_wrap(facets = vars(area_name), ncol = 3, scales = "free_y") +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  theme_light() + 
  theme(
    legend.position = "top"
  )
```

