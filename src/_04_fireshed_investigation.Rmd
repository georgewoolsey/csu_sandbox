# Exploring the Fireshed Registry

The fireshed registry employs a nested spatial framework that organizes landscape variation in wildfire risk to developed areas into containers or “firesheds” and displays these data on a background of maps on management and disturbances, including past and predicted wildfire events and their potential impacts ([Ager et al. 2021](https://scholar.google.com/scholar?cluster=7852635540589253195&hl=en&as_sdt=0,6)). Also, see [Ager et al. (2021b)](https://scholar.google.com/scholar?cluster=735871002853083947&hl=en&as_sdt=0,6).

Each stand belongs to a single planning area, and each planning area belongs to a single fireshed, with the unit area of each scale centered at the desired sizes of 100 ha, 10,000 ha, and 100,000 ha respectively. The delineation process resulted in 7,688 fireshed polygons for the continental United States (fig. 2), 77,112 planning areas, and 9,726,460 stands (stands ranged in size from 5 ha to 117 ha; mean = 80 ha) ([Evers et al. 2020](https://www.fs.usda.gov/rds/archive/Catalog/RDS-2020-0054)). The average area is 101,325 ha for the firesheds and 10,102 ha for the planning areas.

*Data was downloaded from the [USFS Geospatial Data Discovery Portal](https://data-usfs.hub.arcgis.com/) on 2023-05-03*

```{r, echo=FALSE, out.width="70%", out.height="70%", fig.align='center', fig.cap="—National map of the 7,688 firesheds created from community wildfire transmission data", fig.show='hold',results='asis'}
knitr::include_graphics("https://www.fs.usda.gov/research/sites/default/files/styles/700px_wide/public/2023-02/rmrs-fireshed.png?itok=HjfCKaIM")
```


```{r, include=FALSE, warning=F, message=F}
# knit options
knitr::opts_chunk$set(
  echo = TRUE
  , warning = FALSE
  , message = FALSE
  , results='hide'
  , fig.width = 10
  , fig.height = 7
)
# bread-and-butter
library(tidyverse)
library(lubridate)
library(viridis)
library(scales)
library(latex2exp)
# visualization
library(kableExtra)
library(cowplot)
library(RColorBrewer)
library(mapview) #Interactive maps
library(leafpop) #map html popup
# spatial analysis
library(sf)
library(USAboundaries)
# set seed
set.seed(11)
```

```{r, results='hide'}
# turn off the s2 processing 
## https://stackoverflow.com/questions/68478179/how-to-resolve-spherical-geometry-failures-when-joining-spatial-data
sf::sf_use_s2(FALSE)
```

## Read in Firesheds

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls())
gc()
```

```{r rd-fsheds, results='hide'}
# constraint by wf landscape
constrained_by_wflndscp_wide_sf <- sf::st_read("../data/constrained_by_wflndscp_wide_sf.gpkg")
# set crs
transform_crs <- sf::st_crs(constrained_by_wflndscp_wide_sf)
  #rename sf geom column
    names(constrained_by_wflndscp_wide_sf)[names(constrained_by_wflndscp_wide_sf)==tolower(attr(constrained_by_wflndscp_wide_sf, "sf_column"))] = "geometry"
    sf::st_geometry(constrained_by_wflndscp_wide_sf) = "geometry"
### firesheds
fireshed <- sf::st_read("../data/firesheds/Fireshed_Registry3A_Fireshed/Fireshed_Registry%3A_Fireshed_(Feature_Layer).shp") |>
  sf::st_transform(transform_crs) |> 
  setNames(c(
      "shape_id"
      , "area_ha"
      , "fireshed_id"
      , "fireshed_name"
      , "fireshed_code"
      , "fireshed_state"
      , "nopas"
      , "objectid"
      , "fshed_id"
      , "exp_total"
      , "exp_usfs"
      , "exp_nonfs"
      , "exp_usfs_protected"
      , "exp_nonfs_protected"
      , "exp_usfs_managed"
      , "exp_nonfs_managed"
      , "exp_usfs_forest"
      , "exp_nonfs_forest"
      , "exp_usfs_nonforest"
      , "exp_nonfs_nonforest"
      , "exp_usfs_conifer"
      , "exp_nonfs_conifer"
      , "exp_usfs_managedforest"
      , "exp_nonfs_managedforest"
      , "exp_usfs_managedconifer"
      , "exp_nonfs_managedconifer"
      , "exp_nonfs_nonconifer_hihaz"
      , "dist_vs"
      , "crisis_strategy"
      , "key_preformance_indicator"
      , "national_usfs_rank"
      , "national_all_land_rank"
      , "regional_usfs_rank"
      , "regional_all_land_rank"
      , "start_date"
      , "end_date"
      , "geometry"
  )) |> 
  dplyr::mutate(
    exposure_pct_rank = dplyr::percent_rank(exp_total)
    , exposure_pct_rank_grp = dplyr::case_when(
      exposure_pct_rank >= 1-0.01 ~ "Top 1%"
      , exposure_pct_rank >= 1-0.05 ~ "Top 5%"
      , exposure_pct_rank >= 1-0.10 ~ "Top 10%"
      , exposure_pct_rank >= 1-0.25 ~ "Top 25%"
      , TRUE ~ "Bottom 75%"
    ) |> 
    factor(
      levels = c("Top 1%","Top 5%","Top 10%","Top 25%","Bottom 75%")
      , ordered = T
    )
    # there is also a national_all_land_rank column
    , ntllandrank_pct_rank = dplyr::percent_rank(-national_all_land_rank)
    , ntllandrank_pct_rank_grp = dplyr::case_when(
      ntllandrank_pct_rank >= 1-0.01 ~ "Top 1%"
      , ntllandrank_pct_rank >= 1-0.05 ~ "Top 5%"
      , ntllandrank_pct_rank >= 1-0.10 ~ "Top 10%"
      , ntllandrank_pct_rank >= 1-0.25 ~ "Top 25%"
      , TRUE ~ "Bottom 75%"
    ) |> 
    factor(
      levels = c("Top 1%","Top 5%","Top 10%","Top 25%","Bottom 75%")
      , ordered = T
    )
  )
  #rename sf geom column
    names(fireshed)[names(fireshed)==tolower(attr(fireshed, "sf_column"))] = "geometry"
    sf::st_geometry(fireshed) = "geometry"
    # calculate area
    fireshed <- fireshed |> 
      dplyr::mutate(
        fireshed_area_ha = as.numeric(sf::st_area(geometry))/10000
        , fireshed_area_acres = (fireshed_area_ha*10000)/4046.85642
      )
### fireshed_proj_area
fireshed_proj_area <- sf::st_read("../data/firesheds/Fireshed_Registry3A_Project_Area/Fireshed_Registry%3A_Project_Area_(Feature_Layer).shp") |>
  sf::st_transform(transform_crs) |> 
  setNames(c(
      "shape_id"
      , "fireshed_id"
      , "pa_id"
      , "pa_area_ha"
      , "objectid"
      , "pa_id2"
      , "fshed_id"
      , "exp_total"
      , "exp_usfs"
      , "exp_nonfs"
      , "exp_usfs_protected"
      , "exp_nonfs_protected"
      , "exp_usfs_managed"
      , "exp_nonfs_managed"
      , "exp_usfs_forest"
      , "exp_nonfs_forest"
      , "exp_usfs_nonforest"
      , "exp_nonfs_nonforest"
      , "exp_usfs_conifer"
      , "exp_nonfs_conifer"
      , "exp_usfs_managedforest"
      , "exp_nonfs_managedforest"
      , "exp_usfs_managedconifer"
      , "exp_nonfs_managedconifer"
      , "exp_nonfs_nonconifer_hihaz"
      , "dist_vs"
      , "pctrecentlydisturbed"
      , "start_date"
      , "end_date"
      , "geometry"
  )) |> 
  dplyr::mutate(
    exposure_pct_rank = dplyr::percent_rank(exp_total)
    , exposure_pct_rank_grp = dplyr::case_when(
      exposure_pct_rank >= 1-0.01 ~ "Top 1%"
      , exposure_pct_rank >= 1-0.05 ~ "Top 5%"
      , exposure_pct_rank >= 1-0.10 ~ "Top 10%"
      , exposure_pct_rank >= 1-0.25 ~ "Top 25%"
      , TRUE ~ "Bottom 75%"
    ) |> 
    factor(
      levels = c("Top 1%","Top 5%","Top 10%","Top 25%","Bottom 75%")
      , ordered = T
    )
  )
  #rename sf geom column
    names(fireshed_proj_area)[names(fireshed_proj_area)==tolower(attr(fireshed_proj_area, "sf_column"))] = "geometry"
    sf::st_geometry(fireshed_proj_area) = "geometry"
    # calculate area
    fireshed_proj_area <- fireshed_proj_area |> 
      dplyr::mutate(
        pa_area_ha = as.numeric(sf::st_area(geometry))/10000
        , pa_area_acres = (pa_area_ha*10000)/4046.85642
      )
```

```{r, eval=FALSE,include=FALSE}
# write out data for upload to GEE
fireshed_proj_area |> 
  dplyr::inner_join(
    fireshed |>
      sf::st_drop_geometry() |>
      dplyr::select(fireshed_id, crisis_strategy, exp_total
                    , exposure_pct_rank, exposure_pct_rank_grp
      ) |> 
      dplyr::rename(exposure_total=exp_total) |> 
      dplyr::rename_with(
        ~ paste0("fireshed_",.x)
        , -c(fireshed_id)
      )
    , by = dplyr::join_by(fireshed_id)
  ) |>
  dplyr::select(pa_id,pa_area_ha,exp_total,exposure_pct_rank,exposure_pct_rank_grp
                , tidyselect::starts_with("fireshed_")
  ) |> 
  dplyr::rename(exposure_total=exp_total) |> 
  dplyr::rename_with(
    ~ paste0("pa_",.x)
    , -c(geometry,tidyselect::starts_with("fireshed_"),tidyselect::starts_with("pa_"))
  ) |> 
  # usfs region 1-6 states
  sf::st_intersection(
    USAboundaries::us_states(states = c(
      # usfs region 1-6 states
      "MT","WY","CO","NM","AZ","UT","ID","WA","OR","CA","NV"
      , "KS","NE","SD","ND"
    )) |> 
    sf::st_union() |> 
    sf::st_transform(transform_crs)
  ) |> 
  # ggplot() + geom_sf(aes(fill=pa_exposure_pct_rank_grp)) + scale_fill_viridis_d(direction=-1)
  sf::st_write("../data/fireshed_registry_project_area.shp", append=F)
```

```{r}
# what is the area of firesheds that intersect priority landscapes?
fireshed |> 
  sf::st_filter(
    constrained_by_wflndscp_wide_sf |> 
      dplyr::select(area_name)
    , .predicate=st_intersects
  ) |> 
  sf::st_drop_geometry() |> 
  dplyr::mutate(
    crisis_strategy = ifelse(is.na(crisis_strategy),"Not Listed",crisis_strategy)
  ) |> 
  dplyr::group_by(crisis_strategy) |> 
  dplyr::summarise(
    dplyr::across(
      tidyselect::starts_with("fireshed_area_")
      , list(sum=sum,mean=mean)
    )
  ) |> 
  dplyr::mutate(
    dplyr::across(
      tidyselect::starts_with("fireshed_area_")
      , ~ scales::comma(.x, suffix = " M", scale = 1e-6, accuracy = .01)
    )
  )
# what is the area of firesheds within priority landscapes?
fireshed |> 
  sf::st_intersection(
    constrained_by_wflndscp_wide_sf |> 
      dplyr::select(area_name)
  ) |> 
  dplyr::mutate(
    crisis_strategy = ifelse(is.na(crisis_strategy),"Not Listed",crisis_strategy)
  ) |> 
  dplyr::group_by(crisis_strategy) |> 
  dplyr::summarise(
    geometry = sf::st_union(geometry)
  ) |> 
  dplyr::mutate(
    fireshed_area_ha = as.numeric(sf::st_area(geometry))/10000
    , fireshed_area_acres = (fireshed_area_ha*10000)/4046.85642
  ) |> 
  sf::st_drop_geometry() |> 
  dplyr::group_by(crisis_strategy) |> 
  dplyr::summarise(
    dplyr::across(
      tidyselect::starts_with("fireshed_area_")
      , list(sum=sum,mean=mean)
    )
  ) |> 
  dplyr::mutate(
    dplyr::across(
      tidyselect::starts_with("fireshed_area_")
      , ~ scales::comma(.x, suffix = " M", scale = 1e-6, accuracy = .01)
    )
  )


# intersect
fireshed |> 
  sf::st_filter(
    constrained_by_wflndscp_wide_sf |> 
      dplyr::select(area_name)
    , .predicate=st_intersects
  ) |> 
  sf::st_join(
    constrained_by_wflndscp_wide_sf |> 
      dplyr::select(area_name)
    , join = st_intersects
  ) |> 
  dplyr::mutate(
    crisis_strategy = ifelse(is.na(crisis_strategy),"Not Listed",crisis_strategy)
  ) |> 
  ggplot() + 
    geom_sf(
      data = USAboundaries::us_states(states = c(
          # usfs region 1-6 states
          "MT","WY","CO","NM","AZ","UT","ID","WA","OR","CA","NV"
          # , "KS","NE","SD","ND"
        )) |> 
        sf::st_transform(transform_crs)
      , fill = NA
      , color = "gray33"
    ) +
    geom_sf(aes(fill=crisis_strategy)) +
    geom_sf(data=constrained_by_wflndscp_wide_sf,fill=NA,color="black",lwd=0.6)+
    scale_fill_manual(values = c("All-Lands"="firebrick","USFS-Only"="orange3","Not Listed"="gray")) +
    theme_light()
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

## National Fireshed Map

Replicate Figure 2 from [Ager et al. 2021](https://scholar.google.com/scholar?cluster=7852635540589253195&hl=en&as_sdt=0,6) (p. 7)

*National map of the 7,688 firesheds created from community wildfire transmission data (Evers et al. 2020). The fireshed boundaries were created with a process that delineates hotspots of fire transmission to buildings in adjacent or nearby communities. See the Methods section for details on delineating firesheds.*

Note, fireshed percentiles are based on the total exposure within the fireshed (i.e., number of exposed buildings per year)

```{r fshed-plt-rep}
plt_fshed_fn <- function(my_fill = exposure_pct_rank_grp, my_title = "Exposure Percentile") {
  my_fill <- enquo(my_fill)
  plt <- 
    ggplot() + 
      geom_sf(
        data = fireshed
        , mapping = aes(fill=!!my_fill)
        # , mapping = aes(fill=ntllandrank_pct_rank_grp)
      ) + 
      geom_sf(
        data = USAboundaries::us_states() |> 
          dplyr::filter(!stusps %in% c("AK","HI","PR")) |> 
          sf::st_transform(transform_crs)
        , fill = NA
        , color = "gray88"
      ) +
      scale_fill_manual(values=c("firebrick","orange3","khaki","seagreen3","royalblue")) +
      labs(
        x = ""
        , y = ""
        , fill = "Fireshed exposure ranks"
        , subtitle = my_title
      ) +
      theme_light() + 
      theme(
        legend.position = "top"
        , legend.direction = "horizontal"
        , legend.title = element_text(size = 8)
        , legend.text = element_text(size = 7)
        , axis.text = element_text(size=7)
      )
  return(plt)
}
# plot based on exposure column
plt_fshed_fn()
# plot based on rank column
plt_fshed_fn(my_fill = ntllandrank_pct_rank_grp, my_title = "National Land Rank Percentile")
```

## Fireshed Project Area Map

Replicate Figure 1 from [Ager et al. (2021b)](https://scholar.google.com/scholar?cluster=735871002853083947&hl=en&as_sdt=0,6) (p.3)

*Project areas and associated building exposure from ignitions within the project areas on priority lanscape lands in the western US.*

Note, fireshed percentiles are based on the total exposure within the fireshed project area (i.e., number of exposed buildings per year)

```{r fshed-prj-plt-rep}
ggplot() + 
  geom_sf(
    data = USAboundaries::us_states() |> 
      dplyr::filter(stusps %in% c(
        "MT","WY","CO","NM","AZ","UT","ID","WA","OR","CA","NV"
        # , "KS","NE","SD","ND"
      )) |> 
      sf::st_transform(transform_crs)
    , fill = NA
    , color = "gray11"
  ) +
  geom_sf(data = constrained_by_wflndscp_wide_sf, fill = NA, color = "black") +
  geom_sf(
    data = fireshed_proj_area |> 
      sf::st_intersection(constrained_by_wflndscp_wide_sf)
    , mapping = aes(fill=exposure_pct_rank_grp)
  ) + 
  scale_fill_manual(values=c("firebrick","orange3","khaki","seagreen3","royalblue")) +
  labs(
    x = ""
    , y = ""
    , fill = "Fireshed exposure ranks"
  ) +
  theme_light() + 
  theme(
    legend.position = "top"
    , legend.direction = "horizontal"
    , axis.text = element_text(size=7)
  )
```

## Firsheds in landscapes

plot only firsheds that intersect priority landscapes

```{r}
fireshed |>
  sf::st_filter(
    constrained_by_wflndscp_wide_sf |>
      dplyr::select(area_name)
    , .predicate=st_intersects
  ) |>
  sf::st_join(
    constrained_by_wflndscp_wide_sf |>
      dplyr::select(area_name)
    , join = st_intersects
  ) |>
  dplyr::mutate(
    crisis_strategy = ifelse(is.na(crisis_strategy),"Not Listed",crisis_strategy)
  ) |>
  ggplot() + 
    geom_sf(
      data = USAboundaries::us_states(states = c(
          # usfs region 1-6 states
          "MT","WY","CO","NM","AZ","UT","ID","WA","OR","CA","NV"
          # , "KS","NE","SD","ND"
        )) |> 
        sf::st_transform(transform_crs)
      , fill = NA
      , color = "gray33"
    ) +
    geom_sf(aes(fill=crisis_strategy)) +
    geom_sf(data=constrained_by_wflndscp_wide_sf,fill=NA,color="black",lwd=0.6)+
    scale_fill_manual(values = c("All-Lands"="firebrick","USFS-Only"="orange3","Not Listed"="gray")) +
    labs(
      fill = "Crisis Strategy\nCategory"
    ) +
    theme_light() +
    theme(
        legend.position = c(0.9,0.9) # "top"
        # , legend.direction = "horizontal"
        , legend.title = element_text(size = 8)
        , legend.text = element_text(size = 7)
        , axis.text = element_text(size=7)
      )
```

## Firsheds with WCS flag

attempting to match the priority landscape map from the [WCS press kit](https://www.fs.usda.gov/sites/default/files/2023-01/wcs-landscapes2-graphics4.jpg)

```{r, echo=FALSE, out.width="50%", out.height="50%", fig.align='center', fig.cap="Wildfire Crisis Strategy Priority Landscapes", fig.show='hold',results='asis'}
knitr::include_graphics("https://www.fs.usda.gov/sites/default/files/2023-01/wcs-landscapes2-graphics4.jpg")
```

```{r}
  fireshed |> 
    dplyr::filter(!is.na(crisis_strategy)) |> 
    sf::st_intersection(
      USAboundaries::us_states(states = c(
          # usfs region 1-6 states
          "MT","WY","CO","NM","AZ","UT","ID","WA","OR","CA","NV"
          , "SD","ND"
        )) |> 
        sf::st_union() |> 
        sf::st_transform(transform_crs)
    ) |> 
  ggplot() + 
    geom_sf(
      data = USAboundaries::us_states(states = c(
          # usfs region 1-6 states
          "MT","WY","CO","NM","AZ","UT","ID","WA","OR","CA","NV"
          # , "KS","NE","SD","ND"
        )) |> 
        sf::st_transform(transform_crs)
      , fill = NA
      , color = "gray33"
    ) +
    geom_sf(aes(fill=crisis_strategy)) +
    geom_sf(data=constrained_by_wflndscp_wide_sf,fill=NA,color="black",lwd=0.6)+
    scale_fill_manual(values = c("All-Lands"="firebrick","USFS-Only"="orange3","Not Listed"="gray")) +
    labs(
      fill = "Crisis Strategy\nCategory"
    ) +
    theme_light() +
    theme(
        legend.position = c(0.9,0.9) # "top"
        , legend.title = element_text(size = 8)
        , legend.text = element_text(size = 7)
        , axis.text = element_text(size=7)
      )
```


```{r include=FALSE, eval=FALSE}
mapview::mapview(constrained_byftr_huc12_wide_sf, zcol = "cnstrnt_class"
  , col.regions = RColorBrewer::brewer.pal(n=3,name="RdYlBu") |> rev()
  , alpha.regions = 0.6
  , lwd = 0.2
  , label = FALSE
  , legend = FALSE)
xxx <- sf::st_read("../data/treatment_in_landscapes.shp")

```

## Forest Management Activities (FACTS)

The Hazardous Fuel Treatments metadata file is available [here](https://data.fs.usda.gov/geodata/edw/edw_resources/meta/S_USA.Activity_HazFuelTrt_PL.xml) and the Timber Harvests metadata file is available [here](https://data.fs.usda.gov/geodata/edw/edw_resources/meta/S_USA.Activity_TimberHarvest.xml). 

[This appendix](https://www.fs.usda.gov/Internet/FSE_DOCUMENTS/fseprd539041.pdf) includes a listing of all the active and inactive FACTS activity codes, as well as detailed descriptions of some of the codes.

```{r facts-load}
# years back to keep
years_back <- 10
# check for data and download
zip_path <- c(
    "https://data.fs.usda.gov/geodata/edw/edw_resources/fc/S_USA.Activity_HazFuelTrt_PL.gdb.zip"  # haz fuel
    , "https://data.fs.usda.gov/geodata/edw/edw_resources/fc/S_USA.Activity_TimberHarvest.gdb.zip" # timber harv
  )
for (i in 1:length(zip_path)) {
  f_nm <- paste0( "../data/"
    , str_split(zip_path[i], "/", simplify = TRUE)[length(str_split(zip_path[i], "/", simplify = TRUE))]
  )
  fldr <- paste0(gsub(".zip", "", f_nm))
  options(timeout = 60 * 15)
  if(file.exists(fldr) == FALSE){
    # download data
    if(file.exists(f_nm) == FALSE){
      download.file(zip_path[i], destfile = f_nm)
    }else{print("file already exists")}
    # unzip
    unzip(f_nm, overwrite=TRUE, exdir = fldr)
    file.remove(f_nm)
  }else{print("unzip already exists")}
}
# haz_fuel
haz_fuel <- sf::st_read(
    dsn = "../data/S_USA.Activity_HazFuelTrt_PL.gdb/S_USA.Activity_HazFuelTrt_PL.gdb"
    , layer = "Activity_HazFuelTrt_PL"
    # , query = "SELECT * FROM \"Activity_HazFuelTrt_PL\" 
    #             WHERE 
    #               STAGE_VALUE IN ('ACCOMPLISHED')
    #               AND FISCAL_YEAR_COMPLETED = '2023'
    #   "
  ) |>  
  rename_with(~ tolower(
    gsub(" ", "_", 
       str_trim(gsub("\\s+", " ", .x))
    )
  )) |>
  # filter
  dplyr::filter(
    tolower(stage_value) == "accomplished"
    & tolower(cat_nm) %in% c("mechanical", "fire")
    & !stringr::str_detect("pile burn", tolower(treatment_type))
    & fiscal_year_completed >= lubridate::year(Sys.Date())-years_back+1
    & fiscal_year_completed <= lubridate::year(Sys.Date())
    # & lubridate::year(date_completed) >= lubridate::year(Sys.Date())-years_back+1
    # & lubridate::year(date_completed) <= lubridate::year(Sys.Date())
  )
  #rename sf geom column
  names(haz_fuel)[names(haz_fuel)==tolower(attr(haz_fuel, "sf_column"))] = "geometry"
  sf::st_geometry(haz_fuel) = "geometry"
  # transform
  haz_fuel <- haz_fuel |>  
    sf::st_transform(crs=transform_crs) |>  
    dplyr::filter(sf::st_is_valid(geometry)) |>  
    dplyr::mutate(
      facts_src = "haz_fuel"
      , treatment_type = trimws(treatment_type)
      , treatment_category = tolower(cat_nm)
      # , treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
    ) |> 
    dplyr::select(suid, facts_src, treatment_category, treatment_type, date_completed, fiscal_year_completed)
  gc()
# timber harvest
harvests <- sf::st_read(
    dsn = "../data/S_USA.Activity_TimberHarvest.gdb/S_USA.Activity_TimberHarvest.gdb"
    , layer = "Activity_TimberHarvest"
    # , query = "SELECT * FROM \"Activity_TimberHarvest\"
    #             WHERE
    #               STAGE_DESC IN ('ACCOMPLISHED')
    #               AND FY_COMPLETED = '2023'
    #   "
  ) |> 
  rename_with(~ tolower(
    gsub(" ", "_",
       str_trim(gsub("\\s+", " ", .x))
    )
  )) |>  
  dplyr::mutate(fiscal_year_completed = as.numeric(fy_completed)) |> 
  dplyr::filter(
    tolower(stage_desc) == "accomplished"
    & tolower(treatment_type) != "n/a"
    & fiscal_year_completed >= lubridate::year(Sys.Date())-years_back+1
    & fiscal_year_completed <= lubridate::year(Sys.Date())
    # & lubridate::year(date_completed) >= lubridate::year(Sys.Date())-years_back+1
    # & lubridate::year(date_completed) <= lubridate::year(Sys.Date())
  )
  #rename sf geom column
  names(harvests)[names(harvests)==tolower(attr(harvests, "sf_column"))] = "geometry"
  sf::st_geometry(harvests) = "geometry"
  # transform
  harvests <- harvests |>  
    sf::st_transform(crs=transform_crs) |>  
    dplyr::filter(sf::st_is_valid(geometry)) |>  
    dplyr::mutate(
      facts_src = "harvests"
      , treatment_category = "mechanical"
      , treatment_type = trimws(treatment_type)
      # , treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
    ) |> 
    dplyr::select(suid, facts_src, treatment_category, treatment_type, date_completed, fiscal_year_completed)
gc()
```

```{r, warning=F, message=F, echo=FALSE, include=FALSE}
remove(list = c("f_nm", "fldr", "zip_path"))
gc()
```

Combine treatment layers with landscape areas

```{r intrsct-ls-trt}
# combine with wfp areas
treatment_in_landscapes <- rbind(
  # harvests
    sf::st_intersection(
      harvests
      , constrained_by_wflndscp_wide_sf |> 
        dplyr::select(area_name)
    )
  , # haz fuel
    sf::st_intersection(
      haz_fuel
      , constrained_by_wflndscp_wide_sf |> 
        dplyr::select(area_name)
    )
) 
# aggregate by type, area !!!! because some treatment types might overlap spatially
treatment_by_type_area <- treatment_in_landscapes |> 
  sf::st_set_precision(1000000) |> 
  sf::st_make_valid(geometry) |> 
  dplyr::filter(sf::st_is_valid(geometry)) |>  
  dplyr::group_by(area_name, treatment_category) |> 
  dplyr::summarise(
    geometry = sf::st_union(geometry)
    , n_treatments = dplyr::n_distinct(suid)
    , min_fiscal_year_completed = min(fiscal_year_completed)
    , max_fiscal_year_completed = max(fiscal_year_completed)
  ) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(
    treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
    , pot_min_fiscal_year_completed = lubridate::year(Sys.Date())-years_back+1
    , pot_max_fiscal_year_completed = lubridate::year(Sys.Date())
  ) |> 
  # !!!! write out for upload to GEE analysis of treatments by nlcd cov type
  # sf::st_write(sf::st_collection_extract(treatment_by_type_area)
  #            , "../data/treatment_in_landscapes.shp",append=F)
  sf::st_drop_geometry()

# join with full data
treatment_by_type_area <- dplyr::cross_join(
    # unique trt types
    treatment_in_landscapes |> 
      sf::st_drop_geometry() |> 
      dplyr::count(treatment_category) |> 
      dplyr::select(-c(n))
    # unique areas
    , constrained_by_wflndscp_wide_sf |> 
      sf::st_drop_geometry() |> 
      dplyr::count(area_name) |> 
      dplyr::select(-c(n))
  ) |> 
  dplyr::left_join(
    treatment_by_type_area
    , by = dplyr::join_by(area_name, treatment_category)
  ) |> 
  dplyr::inner_join(constrained_by_wflndscp_wide_sf |> sf::st_drop_geometry(), by = dplyr::join_by(area_name)) |> 
  dplyr::mutate(
    treatment_area_ha = ifelse(is.na(treatment_area_ha), 0, treatment_area_ha)
    , treatment_area_acres = (treatment_area_ha*10000)/4046.85642
    , pct_treated_area = treatment_area_ha/feature_area_ha
  )

# aggregate by year, area !!!! because some treatment types might overlap spatially
treatment_by_area_yr <- treatment_in_landscapes |> 
  dplyr::mutate(treatment_year = lubridate::year(date_completed)) |> 
  dplyr::group_by(
      fiscal_year_completed
      , area_name
  ) |> 
  dplyr::summarise(geometry = sf::st_union(geometry)) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(
    treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
  ) |> 
  sf::st_drop_geometry()


# aggregate by year, trt type, area
treatment_by_type_area_yr <- treatment_in_landscapes |> 
  dplyr::mutate(treatment_year = lubridate::year(date_completed)) |> 
  dplyr::group_by(
      fiscal_year_completed
      , facts_src
      , treatment_category
      , area_name
  ) |> 
  dplyr::summarise(geometry = sf::st_union(geometry)) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(
    treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
  ) |> 
  sf::st_drop_geometry()

# create full set of data with all possible combinations
base_join_temp <- constrained_by_wflndscp_wide_sf |> 
  sf::st_drop_geometry() |> 
  dplyr::count(area_name) |> 
  dplyr::select(-c(n)) |> 
  # cross with treatment types
  dplyr::cross_join(
    treatment_by_type_area_yr |> 
      dplyr::count(facts_src,treatment_category) |> 
      dplyr::select(-c(n))
  ) |> 
  # cross with years
  dplyr::cross_join(data.frame(fiscal_year_completed = unique(treatment_by_type_area_yr$fiscal_year_completed)))
# JOIN WITH aggregated data  
# treatment_by_type_area_yr
  treatment_by_type_area_yr <- base_join_temp |> 
    dplyr::left_join(treatment_by_type_area_yr, by = dplyr::join_by(area_name,fiscal_year_completed,facts_src,treatment_category)) |> 
    dplyr::mutate(
      treatment_area_ha = ifelse(is.na(treatment_area_ha), 0, treatment_area_ha)
      , treatment_label = paste0(facts_src,": ",treatment_category) |> tolower()
      , treatment_area_acres = (treatment_area_ha*10000)/4046.85642
    ) |> 
    dplyr::inner_join(constrained_by_wflndscp_wide_sf |> sf::st_drop_geometry(), by = dplyr::join_by(area_name))

# treatment_by_area_yr
  treatment_by_area_yr <- base_join_temp |> 
    dplyr::count(area_name, fiscal_year_completed) |> 
    dplyr::select(-c(n)) |> 
    dplyr::left_join(treatment_by_area_yr, by = dplyr::join_by(area_name,fiscal_year_completed)) |> 
    dplyr::mutate(
      treatment_area_ha = ifelse(is.na(treatment_area_ha), 0, treatment_area_ha)
      , treatment_area_acres = (treatment_area_ha*10000)/4046.85642
    ) |> 
    dplyr::inner_join(constrained_by_wflndscp_wide_sf |> sf::st_drop_geometry(), by = dplyr::join_by(area_name))

```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

Combine treatment layers with watersheds

```{r intrsct-ws-trt}
# combine with wfp areas
treatment_in_watersheds <- rbind(
  # harvests
    sf::st_intersection(
      harvests
      , constrained_byftr_huc12_wide_sf |> 
        dplyr::select(area_name, huc12, cnstrnt_class, rmn_cnstrnt_class)
    )
  , # haz fuel
    sf::st_intersection(
      haz_fuel
      , constrained_byftr_huc12_wide_sf |> 
        dplyr::select(area_name, huc12, cnstrnt_class, rmn_cnstrnt_class)
    )
) 
gc()
# aggregate by trt type, area, constraint class
treatment_by_cnstrnt_type_area <- treatment_in_watersheds |> 
  dplyr::group_by(
      treatment_category
      , area_name
      , cnstrnt_class, rmn_cnstrnt_class
  ) |> 
  dplyr::summarise(
    geometry = sf::st_union(geometry)
    , n_treatments = dplyr::n_distinct(suid)
    , min_fiscal_year_completed = min(fiscal_year_completed)
    , max_fiscal_year_completed = max(fiscal_year_completed)
  ) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(
    treatment_area_ha = as.numeric(sf::st_area(geometry))/10000
    , pot_min_fiscal_year_completed = lubridate::year(Sys.Date())-years_back+1
    , pot_max_fiscal_year_completed = lubridate::year(Sys.Date())
  ) |> 
  sf::st_drop_geometry()
gc()
# join with full data
treatment_by_cnstrnt_type_area <- dplyr::cross_join(
    # unique trt types
    treatment_in_landscapes |> 
      sf::st_drop_geometry() |> 
      dplyr::count(treatment_category) |> 
      dplyr::select(-c(n))
    # unique areas
    , constrained_by_wflndscp_wide_sf |> 
      sf::st_drop_geometry() |> 
      dplyr::count(area_name) |> 
      dplyr::select(-c(n))
  ) |> 
  dplyr::cross_join(
    constrained_byftr_huc12_wide_sf |> 
      sf::st_drop_geometry() |> 
      dplyr::count(cnstrnt_class, rmn_cnstrnt_class) |> 
      dplyr::select(-c(n))
  ) |> 
  dplyr::left_join(
    treatment_by_cnstrnt_type_area
    , by = dplyr::join_by(area_name, treatment_category,cnstrnt_class, rmn_cnstrnt_class)
  ) |> 
  dplyr::left_join(
    sf::st_intersection(
        constrained_byftr_huc12_wide_sf
        , constrained_by_wflndscp_wide_sf |> 
          dplyr::select(geometry)
      ) |> 
        dplyr::mutate(feature_area_ha = as.numeric(sf::st_area(geometry))/10000) |> 
        sf::st_drop_geometry() |> 
        dplyr::group_by(area_name, cnstrnt_class, rmn_cnstrnt_class) |> 
        dplyr::summarise(feature_area_ha = sum(feature_area_ha))
    , by = dplyr::join_by(area_name, cnstrnt_class, rmn_cnstrnt_class)
  ) |> 
  dplyr::mutate(
    treatment_area_ha = ifelse(is.na(treatment_area_ha), 0, treatment_area_ha)
    , treatment_area_acres = (treatment_area_ha*10000)/4046.85642
    , pct_treated_area = treatment_area_ha/feature_area_ha
  )
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
remove(harvests,haz_fuel)
gc()
```

## Treatment acres by year table

```{r trt-yr-tbl, results='asis'}
treatment_table_temp <- treatment_by_type_area_yr |> 
  dplyr::filter(fiscal_year_completed>=2022) |> 
  dplyr::mutate(nm = paste(facts_src,treatment_category,sep = "_")) |> 
  dplyr::select(area_name,fiscal_year_completed,nm,tidyselect::starts_with("treatment_area")) |> 
  tidyr::pivot_wider(
    names_from = nm
    , values_from = tidyselect::starts_with("treatment_area")
    , names_glue = "{nm}_{.value}"
    , values_fill = 0
  ) |> 
  # join with targets
  dplyr::left_join(
    treatment_targets |> 
      dplyr::select(area_name, tidyselect::starts_with("target_acres_20")) |> 
      tidyr::pivot_longer(
        cols = tidyselect::starts_with("target_acres_20")
        , names_to = "fiscal_year_completed"
        , values_to = "target_area_acres"
        , names_prefix = "target_acres_"
        , values_drop_na = F
      ) |> 
      dplyr::mutate(dplyr::across(
        c(fiscal_year_completed,target_area_acres)
        , ~ as.numeric(.x)
      ))
    , by = dplyr::join_by(area_name,fiscal_year_completed)
  ) |> 
  dplyr::inner_join(
    treatment_by_area_yr |> 
      dplyr::select(area_name, fiscal_year_completed, tidyselect::starts_with("treatment_area")) |> 
      dplyr::rename_with(
        ~ paste0("total_", .x)
        , tidyselect::starts_with("treatment_area")
      )
    , by = dplyr::join_by(area_name, fiscal_year_completed)
  ) |> 
  # mutates
  dplyr::mutate(
    pct_to_target = scales::percent(total_treatment_area_acres/target_area_acres,accuracy=0.1)
    , dplyr::across(tidyselect::contains("_area_"), ~ scales::comma(.x,accuracy = 1))
  )
# make a table
kableExtra::kable(
    treatment_table_temp |> dplyr::select(
      fiscal_year_completed
      , tidyselect::ends_with("treatment_area_acres")
      , target_area_acres
      , pct_to_target
    )
    , caption = "Treatments in 21 Wildfire Crisis Strategy Priority Landscapes<br>*only treatments on National Forest System lands shown"
    , col.names = c(
      " "
      , "Timber Harvest: mechanical"
      , "Hazardous Fuel Treatment: fire"
      , "Hazardous Fuel Treatment: mechanical"
      , "Total Treated*"
      , "Target Treated"
      , "% to Target"
    )
  ) |>  
  kableExtra::add_header_above(c(" " = 1, "Acres"=5," "=1)) |>
  kableExtra::kable_classic(full_width=T) |> 
  kableExtra::pack_rows(index = table(forcats::fct_inorder(treatment_table_temp$area_name))) |>
  kableExtra::kable_styling(font_size = 11,fixed_thead = TRUE) |> 
  kableExtra::footnote(
    general = paste0(
      "treatment by fiscal year completed"
      , " | last updated: "
      , file.info("../data/S_USA.Activity_HazFuelTrt_PL.gdb/")$ctime |> lubridate::as_date()
    )
    , symbol = c("overlapping area counted once")
  )
```

## Treatment area versus Mechanically Available Area

```{r trt-avail}
ggplot(
    data = treatment_by_type_area
    , mapping = aes(y = pct_treated_area, x = pct_rmn5_roads, fill = treatment_category)
  ) +
  geom_point(size = 4.5, alpha = 0.8,shape=21,color="gray66") + 
  ggrepel::geom_text_repel(
    mapping = 
      aes(label = stringr::str_wrap(
        ifelse(
          stringr::str_count(area_name, "\\w+")<3
          , stringr::word(area_name,1,stringr::str_count(area_name, "\\w+"))
          , stringr::word(area_name,1,3)
        )
        , 7)
      )
    , size = 2
    , color = "gray33"
    , segment.size = 0.2
    , segment.alpha = 0.6
  ) + 
  facet_grid(cols = vars(stringr::str_to_title(treatment_category))) +
  scale_fill_manual(values = c("firebrick","navy")) +
  scale_x_continuous(labels = scales::percent_format(), breaks = scales::extended_breaks(n=8)) +
  scale_y_continuous(labels = scales::percent_format(), breaks = scales::extended_breaks(n=8)) +
  labs(
    fill = ""
    , y = "% Landscape Area Treated"
    , x = "% Forested Area\nMechanically Available"
    , title = paste0(
      "Treatments Completed FY-"
      , min(treatment_by_type_area$pot_min_fiscal_year_completed)
      , " to FY-"
      , max(treatment_by_type_area$pot_max_fiscal_year_completed)
    )
    , subtitle = "*only treatments on National Forest System lands included"
  ) +
  theme_light() +
  theme(
    legend.position = "none" # c(0.9, 0.9)
    , axis.title = element_text(size=9)
    , axis.text.x = element_text(size=7)
    , strip.text = element_text(color = "black", face = "bold")
    , plot.title = element_text(size = 9)
    , plot.subtitle =  element_text(size = 8)
  )

```

## Treatment in Subwatersheds by Level of Constraint

```{r trt-sw, fig.height=9}
ggplot(
  data = treatment_by_cnstrnt_type_area |> dplyr::filter(treatment_category=="mechanical")
  , mapping = aes(y = cnstrnt_class, x = pct_treated_area, fill = cnstrnt_class)
) +
  geom_col(width = 0.7) +
  geom_text(
    mapping = aes(
      label = scales::percent(pct_treated_area, accuracy = 0.1)
    )
    , color = "black", size = 3
    , hjust = -0.1
  ) +
  scale_fill_brewer(type = "div", palette = "RdYlBu", direction = -1) +
  facet_wrap(
    facets = vars(area_name)
    , ncol = 3
    , labeller = label_wrap_gen(width = 35, multi_line = TRUE)
  ) +
  scale_x_continuous(expand = expansion(mult = c(0, .1)),labels = scales::percent_format()) +
  labs(
    y = "Level of\nConstraint"
    , x = "% Subwatershed Area\nMechanically Treated"
    , title = paste0(
      "Mechanical Treatments Completed FY-"
      , min(treatment_by_type_area$pot_min_fiscal_year_completed)
      , " to FY-"
      , max(treatment_by_type_area$pot_max_fiscal_year_completed)
    )
    , subtitle = "*only treatments on National Forest System lands included"
  ) +
  theme_light() +
  theme(
    legend.position = "none"
    , axis.title = element_text(size=9)
    , axis.text.x = element_text(size=7)
    , plot.title = element_text(size = 9)
    , plot.subtitle =  element_text(size = 8)
  )
```

## Total Area Treated by Level of Constraint

```{r trt-sw-tot}
treatment_by_cnstrnt_type_area |> 
  dplyr::group_by(treatment_category, cnstrnt_class) |> 
  dplyr::summarise(
    dplyr::across(
      tidyselect::starts_with("treatment_area_")
      , ~ sum(.x,na.rm = T)
    )
  ) |> 
ggplot(
  mapping = aes(y = cnstrnt_class, x = treatment_area_acres, fill = cnstrnt_class)
) +
  geom_col(width = 0.7) +
  geom_text(
    mapping = aes(
      label = scales::comma(treatment_area_ha,suffix = "k ha", scale = 1e-3, accuracy = 0.1) 
    )
    , color = "black", size = 3
    , hjust = -0.1
  ) +
  geom_text(
    mapping = aes(
      label = scales::comma(treatment_area_acres,suffix = "k ac", scale = 1e-3, accuracy = 0.1) 
    )
    , color = "black", size = 2.5
    , hjust = -0.15
    , vjust = 3
  ) +
  scale_fill_brewer(type = "div", palette = "RdYlBu", direction = -1) +
  facet_grid(cols = vars(stringr::str_to_title( treatment_category)))+
  scale_x_continuous(expand = expansion(mult = c(0, .2)),labels = scales::comma_format()) +
  labs(
    y = "Level of\nConstraint"
    , x = "Area Treated"
    , title = paste0(
      "Treatments Completed FY-"
      , min(treatment_by_type_area$pot_min_fiscal_year_completed)
      , " to FY-"
      , max(treatment_by_type_area$pot_max_fiscal_year_completed)
    )
    , subtitle = "*only treatments on National Forest System lands included"
  ) +
  theme_light() +
  theme(
    legend.position = "none"
    , axis.title = element_text(size=9)
    , axis.text.x = element_blank()
    , axis.ticks.x = element_blank()
    , strip.text = element_text(color = "black", face = "bold")
    , plot.title = element_text(size = 9)
    , plot.subtitle =  element_text(size = 8)
  )
```

## Treatment by Cover Type

What is the forest versus shrubland classification of the area treated? This [GEE script](https://code.earthengine.google.com/15afaf7d703102e82f82d482552b2356?noload=true) was used to calculate the area within treatment boundaries by NLCD landcover class.

```{r trt-nlcd}
# read data
treatment_in_landscapes_statistics <- readr::read_csv("../data/wildfirepriority/treatment_in_landscapes_statistics.csv") |> 
  dplyr::rename_with(
    ~ gsub("^\\_|\\_$", "", .x)
    , everything()
  ) |> 
  dplyr::select(area_nm,tidyselect::ends_with("_m2"),tidyselect::ends_with("_fs_"),trtmnt) |> 
  dplyr::rename(area_name = area_nm,treatment_category=trtmnt
                ,pot_min_fiscal_year_completed=mn_fs_
                ,pot_max_fiscal_year_completed=mx_fs_
  ) |> 
  dplyr::mutate(dplyr::across(
      tidyselect::ends_with("_m2")
      , ~ .x/10000
    )
  ) |> 
  dplyr::rename_with(
    ~ gsub("_m2", "_ha", .x)
    , tidyselect::ends_with("_m2")
  ) |> 
  dplyr::group_by(area_name,treatment_category
                  ,pot_min_fiscal_year_completed,pot_max_fiscal_year_completed
  ) |> 
  dplyr::summarise(
    dplyr::across(
      tidyselect::ends_with("_ha")
      , ~ sum(.x,na.rm = T)
    )
  ) |> 
  dplyr::ungroup()
# get color list
nlcd_color_temp <- FedData::nlcd_colors() |> dplyr::filter(ID %in% c(42,52)) |> dplyr::pull(Color)
# plot
treatment_in_landscapes_statistics |> 
  dplyr::mutate(
    dplyr::across(
      c(forest_area_ha,shrubland_area_ha)
      , ~ .x/feature_area_ha
      , .names = "pct_{.col}"
    )
  ) |>
  dplyr::mutate(
    pct_other_area_ha = 1-(pct_forest_area_ha+pct_shrubland_area_ha)
  ) |> 
  tidyr::pivot_longer(
      cols = tidyselect::starts_with("pct_")
      , names_to = "class"
      , values_to = "pct_treatment_area"
      , names_prefix = "pct_"
      , values_drop_na = F
    ) |>
  dplyr::mutate(
    class = stringr::str_remove_all(class,"_area_ha") |> stringr::str_to_title()
    , treatment_category = stringr::str_to_title(treatment_category)
  ) |> 
ggplot(
    mapping = aes(x = pct_treatment_area, y = reorder(area_name,desc(area_name)), fill=class)
  ) +
  geom_col(width = 0.7, alpha=0.8) +
  geom_text(
    mapping = aes(
      label = scales::percent(ifelse(pct_treatment_area>.05,pct_treatment_area,NA), accuracy = 1)
    )
    , position = position_stack(vjust = 0.5)
    , color = "black", size = 3
  ) +
  facet_grid(cols = vars( treatment_category))+
  scale_fill_manual(values = c("Forest"=nlcd_color_temp[1],"Shrubland"=nlcd_color_temp[2],"Other"="gray88")) +
  scale_x_continuous(labels = scales::percent_format()) +
  labs(
    fill = "NLCD\nCover\nType"
    , y = ""
    , x = "% Area Treated"
    , title = paste0(
      "Treatments Completed FY-"
      , min(treatment_in_landscapes_statistics$pot_min_fiscal_year_completed)
      , " to FY-"
      , max(treatment_in_landscapes_statistics$pot_max_fiscal_year_completed)
    )
    , subtitle = "*only treatments on National Forest System lands included"
  ) +
  theme_light() +
  theme(
    legend.position = "top" # c(0.9, 0.9)
    , legend.title = element_text(size=9)
    , axis.title = element_text(size=9)
    , axis.text.x = element_text(size=7)
    , strip.text = element_text(color = "black", face = "bold")
    , plot.title = element_text(size = 9)
    , plot.subtitle =  element_text(size = 8)
  )
```

